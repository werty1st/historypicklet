{
  "version": 3,
  "sources": ["../app/app.ts"],
  "sourcesContent": ["import { type } from 'node:os';\nimport mywindow from './window.html';\n\n\n!(async function (){\n\n    const HOST = \"https://\" + process.env.URL;\n\n    console.log(\"injected\");\n    console.log(mywindow);\n    const pdoc = window.open(`${HOST}/${mywindow}`,\"Custom Picks\",\"width=300,height=600,scrollbars=1,resizable=1\");\n\n    function getHeaders() {\n        const headers = {};\n        const user = zdfsite.user;\n        headers[\"Api-Auth\"] = \"Bearer \" + zdfsite.apiToken;\n        const token = user.getState().token;\n        if (token && !user.getState().profile.deactivatePersonalRecommendations) {\n            headers.Authorization = `Bearer ${token}`;\n        }\n    \n        headers['Content-Type'] = 'application/x-www-form-urlencoded';\n        return headers;\n    }\n\n    async function resolveId(externalId){\n\n        const options = {};\n        options['method'] = 'GET';\n        options['headers'] = getHeaders();\n        const url = `https://api.zdf.de/content/embed/${externalId}.json?profile=player2`;\n    \n        const response = await fetch( url, options );\n\n        // if nothing is coming from server that means list was delete on another device\n        if ( !response.ok ) {\n            //throw Error( `${response.status} - ${response.statusText} (for url ${url})` );\n            console.error( `${response.status} - ${response.statusText} (for url ${url})` );\n            return { doc: null, err: response.status };\n        }\n        else {\n            return { doc: await response.json(), err: null };\n        }\n\n    }\n\n    async function postPopup(externalId, payload){\n\n        console.log( `Name: ${payload}, ID: ${externalId}`  );\n        pdoc.postMessage({history: payload, externalId: externalId, datatype: \"json\"}, HOST); \n    }\n\n    interface itemx {\n        leadParagraph: string;\n        title: string \n    }\n\n    async function resolveHistoryItems(){\n        const history: Array<any> = zdfsite.user.getPlaybackHistory().getItems().sort(({eventDate:a}, {eventDate:b}) => (a, b) => (new Date(b) - new Date(a))(a, b));\n        \n        const DEBUG=false;\n        const data = DEBUG?history.slice(0,4):history;\n\n        for await (const entry of data) {\n            \n                \n            //find in cache\n            const cacheJson = localStorage.getItem( entry.externalId );\n            if (!( cacheJson == undefined || cacheJson == \"{}\" || cacheJson == \"\" ))\n            {\n                try {\n                    let tempjson:itemx = JSON.parse(cacheJson);\n                    console.log(tempjson);\n                    postPopup( entry.externalId, cacheJson );\n                } catch (error) {\n                    localStorage.removeItem( entry.externalId );\n                }\n            \n            } else {\n                //get Info from API                \n                const {doc, err} = await resolveId( entry.externalId );\n                if (doc){\n                    const newJson = JSON.stringify({\n                        leadParagraph: doc.leadParagraph,\n                        title: doc.title\n                    });\n                    //store in cache\n                    localStorage.setItem( entry.externalId, newJson );\n                    postPopup( entry.externalId, newJson );\n                }\n                else {\n                    //todo\n                    //remove from user history\n                }\n            }\n\n        }\n\n    }\n\n    async function blacklist(ID:string) {\n        alert(`No history picks for ${ID}`);\n    }\n\n    async function reLoadCluster(ID){\n        console.log(\"reload ID\", ID);\n\n        // window.XCustomID = \"SCMS_c45739d6-6bd5-4fa2-a29b-5e66dde11fa0\"\n        window.XCustomID = ID; //for blacklisting\n        const nodeid = \"34e6008c-7c5c-402e-ace9-fd3e247f6d97\";\n\n        var history = [\n            {\"externalId\":ID,\"eventDate\":\"2021-05-24T13:27:05Z\",\"currentPosition\":99}\n        ]\n        const plays = encodeURIComponent( JSON.stringify(history) ) ;\n\n        const parser = new DOMParser();\n        const html = `\n        <div class=\"js-rb-live\" data-recommendation-cluster-list-uri=\"/broker/relay?plays=${plays}&amp;appId={appId}&amp;abGroup={abGroup}&amp;preferences={preferences}&amp;profile=minimal&amp;configuration=history-picks&amp;pageId=SCMS_2fd1b340-e4db-47f2-b55b-633ac4ed1dba&amp;clusterLimit=1\"\n         data-module=\"recommendation-cluster-list\"\n         data-recommendation-cluster-list-nodeid=\"${nodeid}\">\n        </div>\n        `\n\n        const parsed = parser.parseFromString(html, `text/html`);\n        const newArticle = parsed.querySelector(\"div\");\n        let oldArticle;\n        if ( oldArticle = document.querySelector( `article[data-node-id=\"${nodeid}\"]` ) ){\n            oldArticle.replaceWith(newArticle);\n        } else {\n            oldArticle = document.querySelector(\".sb-page > article\");\n            //var oldArticle = document.querySelector(\".sb-page > .stage-wrapper\")\n            oldArticle.nextElementSibling.prepend(newArticle);\n\n        }\n\n    }\n\n\n    //ready to communicate\n    async function ready(){\n        resolveHistoryItems();\n    }\n    \n\n    function init(){\n\n        if (!window.l1){\n\n            window.addEventListener(\"message\", (event) => {\n                if (event.origin == HOST){\n\n                    try {\n                        const payload = JSON.parse(event.data)\n\n                        if (payload.message === \"ready\"){                    \n                            ready();\n                        } else if (payload.message === \"reload\"){\n                            reLoadCluster(payload.id);\n                        }\n\n                    } catch (error) {\n                        console.error(\"Payload not json\");\n                    }\n                }\n            }, false);\n            \n            console.log(\"parent listener installed\");            \n        } else {\n            window.l1 = true;\n            console.log(\"parent listener exists\");\n        }\n\n        if (!window.f1){\n            var regex1 = /^https:\\/\\/(api|zdf-int-api)\\.(zdf)\\.de\\/broker\\/relay/;\n            var _fetch = window.fetch;\n            \n            window.fetch = async function() {\n                const url = arguments[0];\n                if (regex1.test(url)) {\n            \n                    const ID = window.XCustomID; //\"SCMS_904a8c10-fdf2-4f20-8075-0f8d5b2c9d5b\";\n                    // const plays = \"plays=\" + encodeURIComponent(`[{\"externalId\":\"${ID}\",\"eventDate\":\"2021-05-24T13:27:05Z\",\"currentPosition\":1}]`);\n                    // //const plays = \"plays=%5B%7B%22externalId%22%3A%22SCMS_c45739d6-6bd5-4fa2-a29b-5e66dde11fa0%22%2C%22eventDate%22%3A%222021-05-17T12%3A34%3A39.029Z%22%2C%22currentPosition%22%3A2145%7D%2C%7B%22externalId%22%3A%22SCMS_2ed207cc-ed1f-4cfc-822e-b48deaf974e2%22%2C%22eventDate%22%3A%222021-05-06T12%3A21%3A49.859Z%22%2C%22currentPosition%22%3A1.875531%7D%2C%7B%22externalId%22%3A%22SCMS_29ff63da-eac3-441d-9e5d-b856eed167b1%22%2C%22eventDate%22%3A%222021-05-05T16%3A14%3A59Z%22%2C%22currentPosition%22%3A647%7D%2C%7B%22externalId%22%3A%22SCMS_a50fca6d-765d-4f26-94a6-c92f2ab88cd6%22%2C%22eventDate%22%3A%222021-05-04T20%3A08%3A38.234Z%22%2C%22currentPosition%22%3A126%7D%2C%7B%22externalId%22%3A%22SCMS_38a45c56-32f6-4b73-86d9-9c8391bc5049%22%2C%22eventDate%22%3A%222021-04-24T13%3A27%3A05Z%22%2C%22currentPosition%22%3A7%7D%2C%7B%22externalId%22%3A%22SCMS_265182ac-2236-405b-b1eb-93028e21e09d%22%2C%22eventDate%22%3A%222021-03-28T21%3A17%3A39Z%22%2C%22currentPosition%22%3A1%7D%2C%7B%22externalId%22%3A%22SCMS_686fadc4-a803-4aff-8a59-a5730a64302f%22%2C%22eventDate%22%3A%222021-03-24T19%3A27%3A46.446Z%22%2C%22currentPosition%22%3A787.59091%7D%2C%7B%22externalId%22%3A%22SCMS_2f1d20ec-c6a0-4946-92fb-9c86d57a65aa%22%2C%22eventDate%22%3A%222021-03-01T22%3A23%3A05Z%22%2C%22currentPosition%22%3A5241%7D%2C%7B%22externalId%22%3A%22SCMS_c2ddea41-e0f7-41a7-9fa0-a18747cdf9f2%22%2C%22eventDate%22%3A%222021-02-25T18%3A13%3A02Z%22%2C%22currentPosition%22%3A42%7D%2C%7B%22externalId%22%3A%22SCMS_3fc83c22-1137-4114-85c8-e1dcf4eb8bfa%22%2C%22eventDate%22%3A%222021-02-25T17%3A07%3A14Z%22%2C%22currentPosition%22%3A6%7D%5D\";\n                    // const G = \"gruppe-c\";\n                    // const body = `${plays}&appId=exozet-zdf-pd-0.74.7307&abGroup=${G}&preferences=&profile=minimal&configuration=history-picks&pageId=SCMS_2fd1b340-e4db-47f2-b55b-633ac4ed1dba&clusterLimit=1`;\n                    // arguments[1].body = body;\n                    var x = await _fetch.apply(this, arguments)\n                    if (x.status != 200){\n                        blacklist(ID);\n                    }\n                    return  Promise.resolve(x);\n                }\n               return _fetch.apply(this, arguments);\n            }\n\n            window.f1 = true;\n        } else {\n            console.warn(\"fetch installed\")\n        }        \n\n    }\n\n    init();\n\n\n\n})()\n"],
  "mappings": "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",
  "names": []
}
